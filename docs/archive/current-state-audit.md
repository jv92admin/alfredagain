# Current State Audit: Context & Summarization

**Date:** 2026-01-13  
**Purpose:** Document what exists before building TurnExecutionSummary

---

## 1. Conversation Context (`ConversationContext`)

**Location:** `src/alfred/graph/state.py` lines 505-545

```python
class ConversationContext(TypedDict):
    engagement_summary: str      # "Helping with meal planning..."
    recent_turns: list[dict]     # Last N ConversationTurn objects
    history_summary: str         # Compressed older turns
    step_summaries: list[dict]   # Compressed older steps
    content_archive: dict        # Generated content across turns
    active_entities: dict        # Entity tracking (legacy)
    all_entities: dict           # All entities ever (legacy)
    understand_decision_log: list # V5: Understand's curation history
    pending_clarification: dict  # Tracks propose/clarify state
    id_registry: dict           # V4: SessionIdRegistry serialized
    current_turn: int           # Turn counter
```

**What survives across turns:** Everything in ConversationContext

---

## 2. Conversation Turn (`ConversationTurn`)

**Location:** `src/alfred/graph/state.py` lines 483-492

```python
class ConversationTurn(BaseModel):
    user: str                    # User's message
    assistant: str               # Full response (for display)
    assistant_summary: str       # LLM-condensed (for context)
    timestamp: str               # ISO format
    routing: dict | None         # Router decision
    entities_mentioned: list[str] # Entity IDs touched
```

**Note:** `assistant_summary` is LLM-generated by `_summarize_assistant_response()` for long responses.

---

## 3. Step-Level Data

### Step Results (`step_results`)

**Location:** `AlfredState.step_results: dict[int, Any]`

- Full tool outputs by step index
- Format: `{0: [(tool, table, result), ...], 1: [...], ...}`
- **RESETS EACH TURN** in `think_node()` (line ~165)

### Step Metadata (`step_metadata`)

**Location:** `AlfredState.step_metadata: dict[int, dict]`

- Per-step metadata: `{step_type, subdomain, artifacts, data}`
- Used for artifact preservation (generate steps)
- **RESETS EACH TURN** with step_results

### Prev Step Note (`prev_step_note`)

**Location:** `AlfredState.prev_step_note: str | None`

- Note from Act's `note_for_next_step` output
- Passed to next step within same turn
- **DOES NOT survive turn boundaries**

---

## 4. Content Archive

**Location:** `AlfredState.content_archive` + `ConversationContext.content_archive`

**What it stores:**
```python
{
    "step_0_generate": {
        "description": "Generated 3 recipes",
        "data": [...full generated content...]
    },
    "step_2_analyze": {
        "description": "Analysis of inventory vs recipes",
        "data": {...analysis results...}
    }
}
```

**Created in:** `act_node()` when step_complete for generate/analyze steps  
**Retrieved via:** `{"action": "retrieve_archive", "archive_key": "step_0_generate"}`  
**Survives:** Across turns ✅

---

## 5. Summarize Output (`SummarizeOutput`)

**Location:** `src/alfred/graph/nodes/summarize.py` lines 82-108

```python
class SummarizeOutput(BaseModel):
    entities_created: list[dict]     # [{id, type, label}]
    entities_updated: list[dict]     # [{id, type, label, changes}]
    entities_deleted: list[str]      # IDs
    artifacts_generated: dict        # {type: count}
    artifacts_saved: dict            # {type: count}
    errors: list[SummarizeError]     # Structured errors
    turn_summary: str                # "Goal: X; generated: 3 recipe; saved: 2 recipe"
    steps_completed: int
    steps_total: int
```

**Built by:** `_build_summarize_output()` in Summarize  
**Stored in:** `state["summarize_output"]`  
**Used by:** ❌ **NOTHING!** This is the gap.

---

## 6. Understand Decision Log

**Location:** `ConversationContext.understand_decision_log`

**What it stores:**
```python
[
    {
        "turn": 2,
        "action": "demote", 
        "ref": "recipe_1",
        "reason": "User excluded cod recipes"
    },
    {
        "turn": 3,
        "action": "retain",
        "ref": "recipe_3",
        "reason": "Still being considered for meal plan"
    }
]
```

**Created in:** `understand_node()` when processing `entity_curation`  
**Stored in:** `conversation["understand_decision_log"]` (last 20 entries)  
**Used by:** Next turn's Understand (for continuity)  
**NOT used by:** Think, Act, Reply ❌

---

## 7. Entity Curation Decision

**Location:** `UnderstandOutput.entity_curation: EntityCurationDecision`

```python
class EntityCurationDecision(BaseModel):
    retain_active: list[RetentionDecision]  # [{ref, reason}]
    demote: list[str]                        # Refs to demote
    drop: list[str]                          # Refs to remove entirely
    clear_all: bool                          # Fresh start
```

**Used by:** Understand to update `id_registry`  
**NOT passed to:** Think, Act ❌ (the critical gap)

---

## 8. Step Summary (`StepSummary`)

**Location:** `src/alfred/graph/state.py` lines 494-502

```python
class StepSummary(BaseModel):
    step_index: int
    description: str      # From plan
    subdomain: str
    outcome: str          # One-line summary
    entity_ids: list[str] # For retrieval
    record_count: int
```

**Created by:** `_update_conversation()` for older steps  
**Stored in:** `conversation["step_summaries"]`  
**Used by:** Act can use `retrieve_step` action (rarely used)

---

## 9. What Each Node Asks For / Generates

### Understand
- **Receives:** user_message, conversation, id_registry
- **Generates:** 
  - `entity_curation` (retain/demote/drop decisions)
  - `understand_decision_log_entries` (for storage)
  - `needs_clarification`, `clarification_questions`

### Think  
- **Receives:** user_message, conversation (recent_turns, history_summary), understand_output
- **Generates:**
  - `goal`, `steps`, `decision` (plan_direct/propose/clarify)
  - `proposal_message` or `clarification_questions`
- **RESETS:** `step_results`, `step_metadata` to empty ❌

### Act
- **Receives:** current_step, step_results, step_metadata, prev_step_note, content_archive, conversation
- **Generates:**
  - Tool calls → results stored in `step_results`
  - `note_for_next_step` → stored in `prev_step_note`
  - `artifacts` → stored in `step_metadata` and `content_archive`

### Reply
- **Receives:** step_results, step_metadata, think_output, conversation, pending_action
- **Generates:** `final_response` (natural language)

### Summarize
- **Receives:** step_results, step_metadata, think_output, final_response, conversation
- **Generates:**
  - `summarize_output` (structured audit) ❌ NOT CONSUMED
  - Updates `conversation` (recent_turns, history_summary, content_archive, understand_decision_log)

---

## 10. Key Gaps Identified

### Gap 1: Step Results Don't Survive Turns
- `step_results` reset in `think_node()`
- Think doesn't know what was fetched last turn
- Forces re-reads even when data is in recent context

### Gap 2: Summarize Output Not Consumed
- `SummarizeOutput` is built but never used
- Contains exactly what we need (entities, steps, outcomes)
- Should feed into next turn's Think/Act

### Gap 3: Entity Curation Not Wired to Think
- Understand makes `entity_curation` decisions
- Stored in `understand_decision_log`
- Think never sees what was demoted/retained

### Gap 4: Note for Next Step Dies at Turn Boundary
- `prev_step_note` only works within turn
- Cross-turn notes don't exist
- Analysis conclusions lost

### Gap 5: No Conversation Flow Data
- No tracking of conversation phase (exploring/narrowing/etc)
- No tone tracking
- Reply can't maintain conversational continuity

---

## 11. What We Already Have That's Good

| Feature | Status | Notes |
|---------|--------|-------|
| `content_archive` | ✅ Works | Generated content survives turns |
| `understand_decision_log` | ✅ Works | Curation history preserved |
| `history_summary` | ✅ Works | Old turns compressed |
| `step_summaries` | ✅ Works | Old steps summarized |
| `assistant_summary` | ✅ Works | Long responses condensed |
| `pending_clarification` | ✅ Works | Tracks propose/clarify state |
| `id_registry` | ✅ Works | Entity ID management |

---

## 12. Schema: What Goes Where

```
ConversationContext (persists across turns)
├── recent_turns[]
│   └── ConversationTurn {user, assistant, assistant_summary, routing, entities_mentioned}
├── history_summary (compressed old turns)
├── engagement_summary
├── step_summaries[] (compressed old steps)
├── content_archive{} (generate/analyze results)
├── understand_decision_log[] (curation history)
├── pending_clarification{}
├── id_registry{} (V4 SessionIdRegistry)
└── active_entities, all_entities (legacy)

AlfredState (within-turn, some reset)
├── step_results{} ← RESETS each turn
├── step_metadata{} ← RESETS each turn
├── prev_step_note ← RESETS each turn
├── content_archive{} ← Survives (copied from conversation)
└── summarize_output{} ← Built but not consumed
```

---

## 13. Recommendation for Phase 1

**Don't create new structures from scratch.** Instead:

1. **Extend `SummarizeOutput`** with conversation flow fields
2. **Store `SummarizeOutput`** in conversation as `turn_summaries[]` (last 2)
3. **Wire `understand_decision_log`** entries to Think prompt (same turn)
4. **Add `last_turn_step_summary`** field that survives turn boundary

This builds on what exists rather than duplicating.

---

*Last updated: 2026-01-13*
